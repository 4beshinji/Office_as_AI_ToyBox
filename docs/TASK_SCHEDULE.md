# SOMS 並行開発タスク表・工程表・クリティカルパス

**作成日**: 2026-02-13
**対象フェーズ**: Phase 0 完了 → Phase 1 準備
**基準コミット**: `5a8bdfc` (main)

---

## 1. ワークストリーム概要

7つの独立ワークストリームで並行開発が可能。依存関係のない作業は同時進行できる。

```
                     ┌──── WS-B: データ基盤 ───────────────────┐
                     │     (Event Store, Data Mart)            │
                     │                                         │
WS-A: Git整理 ──────┼──── WS-C: Dashboard/Backend ────────────┤
 (ブロッカー)        │     (users.py, 認証, バッテリーUI)       │
                     │                                         ├──→ Phase 0 完了判定
                     ├──── WS-D: Edge/Hardware ────────────────┤    (24h安定稼働テスト)
                     │     (実機テスト, BLE, OTA)               │
                     │                                         │
                     ├──── WS-E: Voice改善 ────────────────────┤
                     │     (受諾音声ストック)                   │
                     │                                         │
                     ├──── WS-F: Wallet統合 ────────────────────┤
                     │     (E2Eテスト, PostgreSQL)              │
                     │                                         │
                     └──── WS-G: Phase 1 準備 ─────────────────┘
                           (多ゾーン, LoRa, OTA)
```

---

## 2. 全タスク一覧

### 凡例

| 記号 | 意味 |
|------|------|
| 🔴 | クリティカルパス上 |
| ⚡ | ブロッカー (他タスクが依存) |
| 🟢 | 即着手可能 (依存なし) |
| 🟡 | 依存解決待ち |
| 🔵 | 将来フェーズ (Phase 1) |

---

### WS-A: Git 整理 (ブロッカー)

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| A.1 | 🔴⚡ 未コミット変更のコミット (4分割) | なし | 30分 | P0 | 未着手 |
| A.1a | ├ dashboard音声改善コミット | なし | 5分 | - | 未着手 |
| A.1b | ├ wallet統合UIコミット | なし | 5分 | - | 未着手 |
| A.1c | ├ wallet service修正コミット | なし | 5分 | - | 未着手 |
| A.1d | └ docker-compose + PostgreSQL コミット | なし | 5分 | - | 未着手 |
| A.2 | tsconfig.app.tsbuildinfo を .gitignore に追加 | なし | 5分 | P0 | 未着手 |

> **注**: App.tsx のマージコンフリクトは解決済み (UU → M)。

---

### WS-B: データ基盤 (Phase 0 完了必須)

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| B.1 | 🔴 Event Store 設計・技術選定 | A.1 | 2h | P1 | 未着手 |
| B.2 | 🔴 Event Store 実装 (TimescaleDB or SQLite時系列) | B.1 | 8h | P1 | 未着手 |
| B.3 | 🔴 WorldModel → Event Store イベント記録パイプライン | B.2 | 4h | P1 | 未着手 |
| B.4 | 🔴 Data Mart 集約バッチジョブ (1時間) | B.2 | 4h | P1 | 未着手 |
| B.5 | Data Mart JSON スキーマ定義 | B.1 | 2h | P1 | 未着手 |
| B.6 | LLM判断ログ → Event Store 記録 | B.2, B.3 | 3h | P2 | 未着手 |

**依存チェーン**: A.1 → B.1 → B.2 → B.3 → B.4 → Phase 0 完了判定

---

### WS-C: Dashboard / Backend

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| C.1 | 🟢 users.py スタブ → DB 連携に置換 | A.1 | 3h | P1 | 未着手 |
| C.2 | バッテリー監視ダッシュボード (get_swarm_status 可視化) | A.1 | 4h | P2 | 未着手 |
| C.3 | フロントエンドエラーバウンダリ追加 | なし | 2h | P2 | 未着手 |
| C.4 | 認証レイヤー (nginx / API 基本認証) | C.1 | 4h | P2 | 未着手 |
| C.5 | Event Store データのダッシュボード表示 | B.2, C.1 | 4h | P2 | 未着手 |

---

### WS-D: Edge / Hardware

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| D.1 | 🟢 SensorSwarm 実機テスト (ESP32-S3 Hub + ESP32-C3 Leaf) | なし | 8h | P1 | 未着手 |
| D.2 | 🟢 BLE トランスポート実装 (nRF54L15) | なし | 8h | P2 | スタブ |
| D.3 | Wake Chain 検証 (PIR Leaf → Camera GPIO 配線) | D.1 | 4h | P2 | 未着手 |
| D.4 | 🔵 ファームウェア OTA 更新機構 | D.1 | 12h | P3 | 未着手 |
| D.5 | 🔵 Sub-GHz (LoRa) トランスポート追加 | なし | 12h | P3 | 未着手 |
| D.6 | 🔵 センサーノード量産 (config.json 差分化) | D.1, D.4 | 8h | P3 | 未着手 |

---

### WS-E: Voice 改善

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| E.1 | 🟢 受諾音声のストック化 (1-2秒レイテンシ解消) | なし | 3h | P3 | 未着手 |

---

### WS-F: Wallet 統合

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| F.1 | 🔴 Wallet サービス統合テスト (PostgreSQL) | A.1 | 4h | P1 | 未着手 |
| F.2 | XP scorer 統合テスト | F.1 | 2h | P2 | 未着手 |
| F.3 | Wallet ↔ Dashboard E2E テスト | F.1, C.1 | 3h | P2 | 未着手 |

---

### WS-G: Phase 1 準備

| ID | タスク | 依存 | 工数目安 | 優先度 | 状態 |
|----|--------|------|---------|--------|------|
| G.1 | 🔵 WorldModel 多ゾーン同時処理性能最適化 | B.2 | 6h | P3 | 未着手 |
| G.2 | 🔵 カメラ自動検出の本番運用テスト | なし | 4h | P3 | 未着手 |
| G.3 | 🔵 Hub 間通信プロトコル設計 | B.5 | 8h | P3 | 未着手 |

---

## 3. 依存関係グラフ

```
A.1 (Git整理) ─────────────────────────────────────────────────────┐
  │                                                                 │
  ├───→ B.1 (Event Store設計) ──→ B.2 (実装) ──→ B.3 (パイプライン) │
  │                                   │                             │
  │                                   ├──→ B.4 (Data Mart)         │
  │                                   │                             │
  │                                   ├──→ B.5 (スキーマ)          │
  │                                   │                             │
  │                                   ├──→ B.6 (LLMログ)           │
  │                                   │                             │
  │                                   └──→ C.5 (ダッシュボード表示) │
  │                                                                 │
  ├───→ C.1 (users.py) ──→ C.4 (認証) ──→ F.3 (E2E)              │
  │                                                                 │
  ├───→ F.1 (Wallet統合テスト) ──→ F.2 (XPテスト) ──→ F.3          │
  │                                                                 │
  └───→ C.2 (バッテリーUI)                                         │
                                                                    │
D.1 (実機テスト) ──→ D.3 (Wake Chain) ──→ D.4 (OTA) ──→ D.6 (量産)│
                                                                    │
D.2 (BLE実装)      ← 独立                                          │
D.5 (LoRa)         ← 独立                                          │
E.1 (受諾音声)     ← 独立                                          │
G.2 (カメラ検出)   ← 独立                                          │
                                                                    │
  ┌─────────────────────────────────────────────────────────────────┘
  │
  ▼
Phase 0 完了判定: A.1 + B.3 + B.4 + F.1 + 24h安定稼働テスト
```

---

## 4. クリティカルパス

Phase 0 完了を最短で達成するための最長依存チェーン:

```
🔴 A.1 (30分) → B.1 (2h) → B.2 (8h) → B.3 (4h) → B.4 (4h) → 24h安定稼働テスト

合計: 約 18.5h (開発工数) + 24h (安定性テスト) = 最短 42.5h
```

### クリティカルパスの各ステップ

| 順序 | タスク | 内容 | 所要時間 | 累積 |
|------|--------|------|---------|------|
| 1 | A.1 | 未コミット変更の4分割コミット | 0.5h | 0.5h |
| 2 | B.1 | Event Store の技術選定 (TimescaleDB vs SQLite時系列) | 2h | 2.5h |
| 3 | B.2 | Event Store 実装 (Docker統合, マイグレーション) | 8h | 10.5h |
| 4 | B.3 | WorldModel → Event Store パイプライン | 4h | 14.5h |
| 5 | B.4 | Data Mart 1時間集約バッチ | 4h | 18.5h |
| 6 | — | 24時間連続安定稼働テスト | 24h | 42.5h |

### クリティカルパスを短縮する方法

1. **B.1 と B.5 を並行**: スキーマ設計は技術選定と同時進行可能
2. **B.3 と B.4 を並行**: パイプラインとバッチジョブは独立実装可能 (B.2完了後)
3. **B.2 を分割**: Event Store のDB層実装と Brain統合を分離

短縮後:
```
A.1 (0.5h) → B.1 (2h) → B.2 (8h) → B.3 + B.4 並行 (4h) → 安定テスト (24h)
= 38.5h (4h短縮)
```

---

## 5. 並行開発マトリクス

各ワークストリームの同時実行可能性:

```
            WS-A  WS-B  WS-C  WS-D  WS-E  WS-F  WS-G
WS-A (Git)   -     ❌    ❌    ✅    ✅    ❌    ✅
WS-B (Data)        -     ⚠️    ✅    ✅    ✅    ⚠️
WS-C (Dash)              -     ✅    ✅    ⚠️    ✅
WS-D (Edge)                    -     ✅    ✅    ⚠️
WS-E (Voice)                         -     ✅    ✅
WS-F (Wallet)                              -     ✅
WS-G (Ph.1)                                       -

✅ = 完全並行可能  ⚠️ = 部分的依存あり  ❌ = 先行必須
```

### 最大並行度のタイムライン

```
時間軸 →  T0          T1          T2          T3          T4          T5
          │           │           │           │           │           │
開発者1:  [A.1 Git整理]→[B.1 設計]→[   B.2 Event Store 実装   ]→[B.3+B.4]→[安定テスト]
開発者2:  [C.3 エラー ]→[C.1 users]→[C.4 認証]→[C.2 バッテリUI]→[C.5 表示]→[  F.3    ]
開発者3:  [   D.1 SensorSwarm 実機テスト   ]→[D.3 Wake ]→[  D.2 BLE実装  ]→[D.4 OTA ]
開発者4:  [ E.1 受諾 ]→[ F.1 Wallet統合テスト]→[F.2 XP ]→[G.2 カメラ検出 ]→[ G.1    ]
```

---

## 6. Phase 0 完了チェックリスト

CITY_SCALE_VISION.md の Phase 0 完了条件に対応:

| # | 条件 | 対応タスク | 現状 |
|---|------|-----------|------|
| 1 | 全サービスが Docker で安定稼働 (24時間連続) | 安定稼働テスト | 未実施 |
| 2 | センサー → LLM判断 → タスク作成 → 完了の E2E フロー | 既存E2Eテストで確認済み | ✅ |
| 3 | Event Store への全イベント記録 | B.2, B.3 | 未着手 |
| 4 | Data Mart 集約ジョブの自動実行 | B.4 | 未着手 |

### 追加の Phase 0 健全性条件 (暗黙要件)

| # | 条件 | 対応タスク | 現状 |
|---|------|-----------|------|
| 5 | Git が clean 状態 (未コミットなし) | A.1 | 未着手 |
| 6 | users.py がスタブでなくDB連携 | C.1 | スタブ |
| 7 | Wallet E2E 動作確認 | F.1 | 未テスト |
| 8 | 本番LLM (Ollama qwen2.5:14b) での動作確認 | 過去テスト済み | ✅ |

---

## 7. リスクと軽減策

| リスク | 影響 | 軽減策 |
|--------|------|--------|
| Event Store 技術選定が難航 | B.2以降が遅延、クリティカルパス直撃 | SQLite時系列パーティションで最小実装 → 後でTimescaleDB移行 |
| SensorSwarm 実機で ESP-NOW 不安定 | D.1失敗 → D.3, D.4, D.6 連鎖遅延 | 仮想エミュレータ検証済み、UART フォールバック用意 |
| PostgreSQL 導入でWallet統合テスト失敗 | F.1失敗 → F.2, F.3 遅延 | SQLite フォールバック維持 |
| DRIノード番号変動 (カーネル更新時) | Docker GPU パススルー停止 | udev ルール固定化、by-path 指定 |
| 24h安定稼働テストでメモリリーク発覚 | Phase 0 完了遅延 | WorldModel の履歴保持にTTL設定、定期的なメモリプロファイル |

---

## 8. タスク優先度別サマリ

### P0 (今すぐ — ブロッカー)

| ID | タスク | 工数 |
|----|--------|------|
| A.1 | 未コミット変更の4分割コミット | 30分 |
| A.2 | tsconfig.app.tsbuildinfo を .gitignore | 5分 |

### P1 (Phase 0 完了に必須)

| ID | タスク | 工数 | 依存 |
|----|--------|------|------|
| B.1 | Event Store 設計 | 2h | A.1 |
| B.2 | Event Store 実装 | 8h | B.1 |
| B.3 | WorldModel → Event Store パイプライン | 4h | B.2 |
| B.4 | Data Mart 集約バッチ | 4h | B.2 |
| B.5 | Data Mart スキーマ定義 | 2h | B.1 |
| C.1 | users.py DB連携 | 3h | A.1 |
| D.1 | SensorSwarm 実機テスト | 8h | なし |
| F.1 | Wallet 統合テスト | 4h | A.1 |

**P1 合計**: ~35h (並行開発で2人なら ~20h実時間)

### P2 (品質向上)

| ID | タスク | 工数 | 依存 |
|----|--------|------|------|
| B.6 | LLM判断ログ記録 | 3h | B.2 |
| C.2 | バッテリー監視UI | 4h | A.1 |
| C.3 | エラーバウンダリ | 2h | なし |
| C.4 | 認証レイヤー | 4h | C.1 |
| C.5 | Event Storeダッシュボード | 4h | B.2 |
| D.2 | BLE トランスポート | 8h | なし |
| D.3 | Wake Chain 検証 | 4h | D.1 |
| F.2 | XP scorer テスト | 2h | F.1 |
| F.3 | Wallet E2E テスト | 3h | F.1, C.1 |

**P2 合計**: ~34h

### P3 (Phase 1 準備・将来)

| ID | タスク | 工数 | 依存 |
|----|--------|------|------|
| D.4 | OTA 更新機構 | 12h | D.1 |
| D.5 | LoRa トランスポート | 12h | なし |
| D.6 | センサーノード量産 | 8h | D.1, D.4 |
| E.1 | 受諾音声ストック化 | 3h | なし |
| G.1 | 多ゾーン性能最適化 | 6h | B.2 |
| G.2 | カメラ検出本番テスト | 4h | なし |
| G.3 | Hub間通信設計 | 8h | B.5 |

**P3 合計**: ~53h

---

## 9. 推奨着手順序

### 単独開発者の場合

```
Week 1:
  Day 1: A.1 (コミット整理) → F.1 (Wallet テスト) → C.1 (users.py)
  Day 2: B.1 (Event Store 設計) → B.5 (スキーマ) → B.2 開始
  Day 3-4: B.2 (Event Store 実装)
  Day 5: B.3 + B.4 (パイプライン + バッチ)

Week 2:
  Day 1: 24h 安定稼働テスト開始 → D.1 (SensorSwarm 実機) 並行
  Day 2: D.1 続行 + テスト結果確認
  Day 3: C.2 (バッテリーUI) + C.4 (認証)
  Day 4: F.2 + F.3 (Wallet E2E)
  Day 5: B.6 (LLMログ) + C.5 (データ表示)
```

### 2名並行開発の場合

```
         開発者A (バックエンド/インフラ)      開発者B (フロントエンド/エッジ)
Week 1:
  Day 1: A.1 コミット → B.1 設計              D.1 SensorSwarm 実機テスト
  Day 2: B.2 Event Store 実装                 D.1 続行 → C.3 エラーバウンダリ
  Day 3: B.2 続行                             C.1 users.py → C.2 バッテリーUI
  Day 4: B.3 パイプライン + B.4 バッチ         F.1 Wallet テスト → F.2 XP
  Day 5: B.6 LLMログ + 安定テスト開始          C.4 認証 → F.3 E2E

Week 2:
  Day 1: 安定テスト監視 + C.5 データ表示       D.3 Wake Chain → D.2 BLE
  Day 2: G.1 多ゾーン最適化                   D.2 BLE 続行
  Day 3: G.3 Hub間通信設計                    E.1 受諾音声ストック
  ...
```

---

## 10. Phase 0 → Phase 1 移行判定基準

Phase 0 完了後、Phase 1 に移行するための判断基準:

| 項目 | 閾値 | 測定方法 |
|------|------|---------|
| 連続稼働 | 24時間+ | Docker uptime |
| E2E レイテンシ | < 10秒 (センサー→タスク) | E2Eテスト計測 |
| LLM判断精度 | > 80% | 手動評価 (50判断サンプル) |
| 誤タスク率 | < 10% | 24h中のfalse positive |
| デバイス再接続率 | > 95% | SwarmHub heartbeat |
| Event Store記録漏れ | < 0.1% | Data Lake件数 vs MQTT受信件数 |
| Data Mart生成 | 24件/日 (1時間ごと) | 自動バッチ実行ログ |

---

## 付録: 全タスクID索引

| ID | タスク名 | WS | 優先度 |
|----|---------|-----|--------|
| A.1 | 未コミット変更4分割コミット | A | P0 |
| A.2 | .gitignore 更新 | A | P0 |
| B.1 | Event Store 設計 | B | P1 |
| B.2 | Event Store 実装 | B | P1 |
| B.3 | WorldModel→EventStore パイプライン | B | P1 |
| B.4 | Data Mart 集約バッチ | B | P1 |
| B.5 | Data Mart スキーマ定義 | B | P1 |
| B.6 | LLM判断ログ記録 | B | P2 |
| C.1 | users.py DB連携 | C | P1 |
| C.2 | バッテリー監視UI | C | P2 |
| C.3 | エラーバウンダリ | C | P2 |
| C.4 | 認証レイヤー | C | P2 |
| C.5 | Event Storeダッシュボード表示 | C | P2 |
| D.1 | SensorSwarm 実機テスト | D | P1 |
| D.2 | BLE トランスポート実装 | D | P2 |
| D.3 | Wake Chain 検証 | D | P2 |
| D.4 | ファームウェアOTA | D | P3 |
| D.5 | LoRa トランスポート | D | P3 |
| D.6 | センサーノード量産 | D | P3 |
| E.1 | 受諾音声ストック化 | E | P3 |
| F.1 | Wallet 統合テスト | F | P1 |
| F.2 | XP scorer テスト | F | P2 |
| F.3 | Wallet E2E テスト | F | P2 |
| G.1 | 多ゾーン性能最適化 | G | P3 |
| G.2 | カメラ検出本番テスト | G | P3 |
| G.3 | Hub間通信設計 | G | P3 |
