services:
  # --- Central Bus ---
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: soms-mqtt
    restart: always
    ports:
      - "${MQTT_BIND_ADDR:-0.0.0.0}:1883:1883" # Exposed for Edge Devices
      - "${MQTT_BIND_ADDR:-0.0.0.0}:9001:9001" # Websocket
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./mosquitto/passwd:/mosquitto/config/passwd:ro
      - soms_mqtt_data:/mosquitto/data
      - soms_mqtt_log:/mosquitto/log
    networks:
      - soms-net
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -h localhost -p 1883 -u ${MQTT_USER:-soms} -P ${MQTT_PASS:-soms_dev_mqtt} -t '$$SYS/broker/version' -C 1 -W 5 2>/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # --- Central Intelligence (Brain) ---
  # NOTE: In a distributed setup, this might run elsewhere.
  # Here we assume it runs alongside the bus.
  brain:
    build: ../services/brain
    container_name: soms-brain
    restart: always
    depends_on:
      mosquitto:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_USER=${MQTT_USER:-soms}
      - MQTT_PASS=${MQTT_PASS:-soms_dev_mqtt}
      - LOG_LEVEL=INFO
      - LLM_API_URL=${LLM_API_URL:-http://mock-llm:8000/v1}
      - LLM_MODEL=${LLM_MODEL}
    volumes:
      - ../services/brain/src:/app
    networks:
      - soms-net
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('mosquitto',1883),5); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # --- PostgreSQL ---
  postgres:
    image: postgres:16-alpine
    container_name: soms-postgres
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-soms}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-soms_dev_password}
      - POSTGRES_DB=soms
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - soms_pg_data:/var/lib/postgresql/data
    networks:
      - soms-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-soms} -d soms"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # --- Dashboard Backend ---
  backend:
    build: ../services/dashboard/backend
    container_name: soms-backend
    restart: always
    ports:
      - "8000:8000"
    depends_on:
      mosquitto:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - ../services/dashboard/backend:/app
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-soms}:${POSTGRES_PASSWORD:-soms_dev_password}@postgres:5432/soms
      - MQTT_BROKER=mosquitto
    networks:
      - soms-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  frontend:
    build: ../services/dashboard/frontend
    container_name: soms-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - soms-net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --- VOICEVOX Engine ---
  voicevox:
    build: ../services/voice/voicevox
    container_name: soms-voicevox
    restart: always
    ports:
      - "50021:50021"
    networks:
      - soms-net
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/50021' 2>/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # --- Voice Service ---
  voice-service:
    build: ../services/voice
    container_name: soms-voice
    restart: always
    ports:
      - "8002:8000"
    depends_on:
      voicevox:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - VOICEVOX_URL=http://voicevox:50021
      - LLM_API_URL=${LLM_API_URL:-http://mock-llm:8000/v1}
      - LLM_MODEL=${LLM_MODEL}
    volumes:
      - ../services/voice/src:/app
      - soms_audio_data:/app/audio
    networks:
      - soms-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # --- Wallet Service ---
  wallet:
    build: ../services/wallet
    container_name: soms-wallet
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-soms}:${POSTGRES_PASSWORD:-soms_dev_password}@postgres:5432/soms
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-soms}
      - MQTT_PASS=${MQTT_PASS:-soms_dev_mqtt}
    volumes:
      - ../services/wallet/src:/app
    networks:
      - soms-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # --- Local LLM Engine (Ollama) ---
  ollama:
    image: ollama/ollama:rocm
    container_name: soms-ollama
    restart: always
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri/card1:/dev/dri/card1
      - /dev/dri/renderD128:/dev/dri/renderD128
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    environment:
      - HSA_OVERRIDE_GFX_VERSION=12.0.1
    networks:
      - soms-net
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/11434' 2>/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Mock LLM for development/testing
  mock-llm:
    build: ./mock_llm
    container_name: soms-mock-llm
    restart: unless-stopped
    ports:
      - "8001:8000"
    networks:
      - soms-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --- Perception Node ---
  perception:
    build: ../services/perception
    container_name: soms-perception
    restart: always
    depends_on:
      mosquitto:
        condition: service_healthy
    network_mode: host
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri/card1:/dev/dri/card1
      - /dev/dri/renderD128:/dev/dri/renderD128
    group_add:
      - video
    security_opt:
      - seccomp:unconfined
    environment:
      - MQTT_BROKER=localhost
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-soms}
      - MQTT_PASS=${MQTT_PASS:-soms_dev_mqtt}
      - HSA_OVERRIDE_GFX_VERSION=12.0.1
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',1883),5); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  soms_mqtt_data:
  soms_mqtt_log:
  soms_pg_data:
  soms_audio_data:
  ollama_models:


networks:
  soms-net:
    driver: bridge
